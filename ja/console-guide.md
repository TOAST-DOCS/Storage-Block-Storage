## Storage > Block Storage > コンソール使用ガイド

## ブロックストレージの作成

インスタンスに接続するブロックストレージを作成します。

ブロックストレージは、何もデータが入っていない空のブロックストレージとして作成することもでき、既存ブロックストレージのスナップショットでも作成できます。

空のブロックストレージを作成するには、 **Block Storageソース**を**ソースなし、空のBlock Storage**で選択します。空のブロックストレージは、インスタンスに接続後、パーティションを分割してフォーマットした後に使用する必要があります。ブロックストレージの使用方法については[ブロックストレージ概要 > 空のブロックストレージの使用](/Storage/Block%20Storage/ja/overview/#_1)を参照してください。空のブロックストレージが位置するアベイラビリティーゾーン(availability zone)は、作成するブロックストレージを接続するインスタンスがあるアベイラビリティーゾーンを使用します。ブロックストレージタイプは必要なI/O性能に応じて**HDD**、**SSD** の中から1つを選択します。

ブロックストレージのスナップショットからブロックストレージを作成することもできます。スナップショットからブロックストレージを作成する場合、ブロックストレージのサイズはスナップショットのサイズと同じかそれより大きくなければいけません。サイズをさらに大きく設定するには、お客様が直接既存ブロックストレージのパーティションを調整するか、新しいパーティションを追加し、増えた記憶領域を使用する必要があります。

### 暗号化ブロックストレージ

ブロックストレージタイプで**Encrypted HDD**、**Encrypted SSD**を選択して暗号化ブロックストレージを作成できます。暗号化ブロックストレージはNHN CloudのSecure Key Managerサービスで管理する対称鍵を使用して暗号化されます。したがって、暗号化ブロックストレージを作成するには、事前にSecure Key Managerサービスで対称鍵を作成する必要があります。

暗号化ブロックストレージに適用されるポリシーは次のとおりです。

* 暗号化、復号により、一般ブロックストレージタイプ(**HDD**、**SSD**)に比べてI/O性能が低下することがあります。
* 暗号化ブロックストレージを作成する時に登録した対称鍵IDは変更できません。対称鍵を変更するにはSecure Key Managerサービスでキーのローテーションを使用する必要があります。
* 暗号化ブロックストレージを選択した後、**キーローテーション**ボタンを押すと以前のバージョンのキーで暗号化されたブロックストレージを最新バージョンのキーで再暗号化できます。

> [参考]
バックアップ商品を利用してキー削除などによるデータ損失に備え、複製を作成して安全に保管できます。

<!-- 改行のための注釈なので、必ず含める必要があります。--> 

> [注意]
Secure Key Managerサービスで暗号化ブロックストレージに設定した対称鍵を削除した後、そのブロックストレージをインスタンスから接続解除すると、再度復号化することができません。対称鍵を誤って削除しないように注意して管理する必要があります。

## ブロックストレージの削除

ブロックストレージを削除する前に、次の事項を確認します。

* インスタンスに接続されているブロックストレージは削除できません。まず接続を解除します。
* スナップショットを持っているブロックストレージは削除できません。ブロックストレージのスナップショットを全て削除します。

一度削除されたブロックストレージは二度と復旧できません。

## ブロックストレージサイズの変更

ブロックストレージのサイズを変更できます。ブロックストレージのサイズは小さくすることはできず、大きくすることしかできません。

インスタンスに接続されたブロックストレージの場合、下記を参考にしてパーティションとファイルシステムを拡張する必要があります。

### Linuxインスタンス

#### パーティション拡張

1. ブロックストレージのパーティションを確認します。

        # sudo lsblk

    パーティションが存在しない場合、下記の「ファイルシステムの拡張」に移動します。

2. パーティションを拡張します。

    例えば、`/dev/vda`デバイスの`1番パーティション`を拡張する場合は下記のようにします。

        # sudo growpart /dev/vda 1

3.拡張されたパーティションを確認します。

        # sudo lsblk

#### ファイルシステムの拡張

1. 拡張するファイルシステムのタイプを確認します。

        # df -hT

2.ファイルシステムの種類によって下記のコマンドを入力して拡張します。

    **[XFSファイルシステム]**例えば、`/`にマウントされたファイルシステムを拡張する場合は下記のようにします。

        # sudo xfs_growfs -d /

    **[Ext4ファイルシステム]**例えば、`/dev/vda`デバイスのファイルシステムを拡張する場合は下記のようにします。

        # sudo resize2fs /dev/vda    

3.拡張されたファイルシステムを確認します。

        # df -hT


### Windowsインスタンス

1. **Run**で**diskmgmt.msc**と入力し、**OK**をクリックしてディスク管理ユーティリティを実行します。
![image.png](https://static.toastoven.net/prod_infrastructure/block_storage/windows_volume_extend_01.png)
2.ブロックストレージに追加されたサイズだけ**Unallocated**の状態で表示されます。拡張されたドライブを右クリックした後、**Extend Volume...**をクリックしてボリューム拡張ウィザードを実行します。
![image.png](https://static.toastoven.net/prod_infrastructure/block_storage/windows_volume_extend_02.png)
3.ボリューム拡張ウィザードで**Next**をクリックします。**Select the amount of space in MB**に拡張するメガバイト数を入力します。

    入力可能な最大メガバイト数は**Maximum available space in MB**を参照してください。もう一度**Next**を押してボリューム拡張ウィザードを完了します。
![image.png](https://static.toastoven.net/prod_infrastructure/block_storage/windows_volume_extend_03.png)
4. **This PC** で拡張されたドライブを確認します。
![image.png](https://static.toastoven.net/prod_infrastructure/block_storage/windows_volume_extend_04.png)

## 接続の管理

### ブロックストレージの接続

インスタンスにブロックストレージを接続します。インスタンスが実行中の時にも接続できます。ブロックストレージは同じアベイラビリティーゾーンにあるインスタンスにのみ接続できます。ブロックストレージを作成する時、接続するインスタンスと同じアベイラビリティーゾーンでブロックストレージを作成するようにします。

空のブロックストレージを接続すると、インスタンスからパーティションを分割してフォーマットした後に使用する必要があります。フォーマットされたブロックストレージはマウントして使用します。スナップショットで作成したブロックストレージもお客様が直接インスタンス内でマウントすると使用できます。

> [参考]
> オペレーションシステムの機能によって自動的にマウントされ、別途マウントする必要がない場合もあります。

### ブロックストレージの接続解除

インスタンスで必要ないブロックストレージの接続を解除します。ただし、ルートブロックストレージはインスタンスから接続解除できません。

インスタンスが実行中の状態でもブロックストレージの接続を解除できます。ただし、先にインスタンスでブロックストレージのマウントを解除し、コンソールでブロックストレージの接続を解除する必要があります。ブロックストレージがマウントされた状態で接続を解除すると、次のような問題が発生します。

1. ブロックストレージのデータが損傷し、データが消失する場合があります。
2. ブロックストレージを新たに追加すると、コンソールのブロックストレージ名とインスタンスのブロックストレージ名が別々になります。コンソールとインスタンスで同じブロックストレージ名が表示されるようにするにはインスタンスを再起動する必要があります。

**Linuxインスタンス**

	# umount <マウントポイント>

**Windowsインスタンス**

**ディスクの管理**で該当のディスクを**オフライン**にした後、接続を解除します。

## スナップショットの作成

ブロックストレージの読み取り専用のコピーを作成します。ブロックストレージがインスタンスに接続されている状態でも、ブロックストレージのスナップショットを作成できますが、データの整合性と安定性を保障するには、インスタンスから接続を解除してブロックストレージのスナップショットを作成することを推奨します。

## ブロックストレージ複製

ブロックストレージを複製して利用できます。ブロックストレージがインスタンスに接続されている状態でも複製できますが、データの整合性と安定性を保障するためにインスタンスを終了するか、接続を解除してから複製することを推奨します。

複製リクエスト後、複製状態および成否は[複製結果]で確認できます。

> [参考]
> レプリケーション機能は一度きりであり、それ以降の元のブロックストレージの変動事項は反映されません。

<!-- 改行のためのコメントのため必ず含める必要があります。 -->

> [注意]
> レプリケーションを進行するには、ブロックストレージ内に少なくとも100KB以上の空き容量が必要です。

### 対象プロジェクト

レプリカを作成する対象プロジェクトを選択します。

* 同じプロジェクト:同じプロジェクトに複製
* 他のプロジェクト:自分が所属する他のプロジェクトに複製

### リージョン

レプリカを作成する対象リージョンを選択します。

### ブロックストレージタイプ

複製するリージョンで利用するブロックストレージタイプを選択します。現在のリージョンで利用中のブロックストレージタイプとは異なるタイプを選択できます。

### アベイラビリティゾーン

複製するリージョンで利用するアベイラビリティゾーンを選択します。現在のリージョンで利用中のアベイラビリティゾーンとは異なるアベイラビリティゾーンを選択できます。

## ブロックストレージ移動

ブロックストレージを同一組織内の他のプロジェクトに移動できます。リクエストを行うユーザーは、元のプロジェクトと移動先プロジェクトの両方に対して適切な権限を持っている必要があります。

> [参考]
スナップショットが存在するブロックストレージは移動できません。

<!-- 改行のためのコメントであり、必ず含める必要があります。 -->

### 対象プロジェクト

ブロックストレージを移動する対象プロジェクトのIDを入力します。移動先プロジェクトは同一組織内のプロジェクトでなければなりません。

### 暗号化対称鍵ID

暗号化されたブロックストレージを移動する場合、対象プロジェクトで使用する暗号化対称鍵IDを入力します。

## トラブルシューティング

### 意図しないブロックストレージで起動する問題

インスタンスに追加で接続したブロックストレージが`/`にマウントされた状態でインスタンスが起動することがあります。この現象は、主にインスタンスのOSイメージで作成されたブロックストレージを他のインスタンスに追加で接続するときに発生します。

Linuxは起動時に`/etc/fstab`で`/`にマウントするブロックストレージを決定します。 NHN Cloudで使用するOSイメージの場合、ファイルシステムUUIDに基づいてマウントするブロックストレージを決定します。ファイルシステムUUID値が同じブロックストレージが接続されると、意図しないブロックストレージが`/`にマウントされることがあります。

```console
# cat /etc/fstab
...
UUID=6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02 /                       xfs     defaults        0 0
```

`blkid`コマンドでブロックストレージのファイルシステムUUIDを確認できます。

```console
# blkid
/dev/vda1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"
/dev/vdb1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"
```

上記のように追加で接続したブロックストレージのファイルシステムUUIDが同じ場合、Linuxディストリビューション動作方式によっては追加で接続したブロックストレージが`/`にマウントされることがあります。

次の手順で2つのブロックストレージのファイルシステムUUIDが異なるようにして問題を解決します。

1. インスタンスを停止した後、問題を引き起こす(すなわち`/`で誤ってマウントされていた) [ブロックストレージの接続を解除](console-guide/#_5)します。

2. インスタンスを起動します。

3. 起動が完了したら、問題を引き起こす[ブロックストレージを再接続](console-guide/#_4)します。

4. 以下のコマンで問題を引き起こすブロックストレージのファイルシステムUUIDを変更します。問題を引き起こすブロックストレージのタイプに応じて以下のコマンドを実行します。ブロックストレージのタイプは`blkid`コマンドで確認できます。

	問題を引き起こすブロックストレージのファイルシステムがext4の場合、

	<pre><code class="language-console"># tune2fs -U random /dev/vdb1
	tune2fs 1.42.9 (28-Dec-2013)
	Setting the UUID on this filesystem could take some time.
	Proceed anyway (or wait 5 seconds to proceed) ? (y,N) y
	</code></pre>

	問題を引き起こすブロックストレージのファイルシステムがxfsの場合、

	<pre><code class="language-console"># xfs_admin -U generate /dev/vdb1
	Clearing log and setting UUID
	writing all SBs
	new UUID = 0037c590-0545-4736-bcdc-d052681eb5f5
	</code></pre>

5. ファイルシステムUUIDが変更されたことを確認します。

	<pre><code class="language-console"># blkid
	/dev/vda1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"
	/dev/vdb1: UUID="0037c590-0545-4736-bcdc-d052681eb5f5" TYPE="xfs"
	</code></pre>

### ブロックストレージのマウントに失敗してインスタンスが動作しない問題

ブロックストレージを追加する時、`/etc/fstab`を誤って設定すると、起動過程でボリュームマウントに失敗し、インスタンスがemergency modeに入ることがあります。

このような状況を防ぐために、追加ブロックストレージを`/etc/fstab`に登録する場合は、[ブロックストレージマウントガイド](/Storage/Block%20Storage/ja/overview/#_4)に従って、`nofail`オプションを使用することを推奨します。

もし`/etc/fstab`を誤って修正し、インスタンスが正常に起動しない場合は、サポートにお問い合わせください。

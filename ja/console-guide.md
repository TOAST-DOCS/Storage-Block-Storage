## Storage > Block Storage > コンソール使用ガイド

## ブロックストレージの作成

インスタンスに接続するブロックストレージを作成します。

ブロックストレージは、何もデータが入っていない空のブロックストレージとして作成することもでき、既存ブロックストレージのスナップショットでも作成できます。

空のブロックストレージを作成するには、 **Block Storageソース**を**ソースなし、空のBlock Storage**で選択します。空のブロックストレージは、インスタンスに接続後、パーティションを分割してフォーマットした後に使用する必要があります。ブロックストレージの使用方法については[ブロックストレージ概要 > 空のブロックストレージの使用](/Storage/Block%20Storage/ja/overview/#_1)を参照してください。空のブロックストレージが位置するアベイラビリティーゾーン(availability zone)は、作成するブロックストレージを接続するインスタンスがあるアベイラビリティーゾーンを使用します。ボリュームタイプは必要なI/O性能に応じて**HDD**、**SSD** の中から1つを選択します。

ブロックストレージのスナップショットからブロックストレージを作成することもできます。スナップショットからブロックストレージを作成する場合、ブロックストレージのサイズはスナップショットのサイズと同じかそれより大きくなければいけません。サイズをさらに大きく設定するには、お客様が直接既存ブロックストレージのパーティションを調整するか、新しいパーティションを追加し、増えた記憶領域を使用する必要があります。

スナップショットでブロックストレージを作成する場合、ブロックストレージのアベイラビリティーゾーンはスナップショットが保存されているアベイラビリティーゾーンに固定されます。スナップショットと異なるアベイラビリティーゾーンにはブロックストレージを作成できません。

## ブロックストレージの削除

ブロックストレージを削除する前に、次の事項を確認します。

* インスタンスに接続されているブロックストレージは削除できません。まず接続を解除します。
* スナップショットを持っているブロックストレージは削除できません。ブロックストレージのスナップショットを全て削除します。

一度削除されたブロックストレージは二度と復旧できません。

## 接続の管理

### ブロックストレージの接続

インスタンスにブロックストレージを接続します。インスタンスが実行中の時にも接続できます。ブロックストレージは同じアベイラビリティーゾーンにあるインスタンスにのみ接続できます。ブロックストレージを作成する時、接続するインスタンスと同じアベイラビリティーゾーンでブロックストレージを作成するようにします。

空のブロックストレージを接続すると、インスタンスからパーティションを分割してフォーマットした後に使用する必要があります。フォーマットされたブロックストレージはマウントして使用します。スナップショットで作成したブロックストレージもお客様が直接インスタンス内でマウントすると使用できます。

> [参考]
> オペレーションシステムの機能によって自動的にマウントされ、別途マウントする必要がない場合もあります。

### ブロックストレージの接続解除

インスタンスで必要ないブロックストレージの接続を解除します。ただし、基本ディスクはインスタンスから接続解除できません。

インスタンスが実行中の状態でもブロックストレージの接続を解除できます。ただし、先にインスタンスでブロックストレージのマウントを解除し、コンソールでブロックストレージの接続を解除する必要があります。ブロックストレージがマウントされた状態で接続を解除すると、次のような問題が発生します。

1. ブロックストレージのデータが損傷し、データが消失する場合があります。
2. ブロックストレージを新たに追加すると、コンソールのブロックストレージ名とインスタンスのブロックストレージ名が別々になります。コンソールとインスタンスで同じブロックストレージ名が表示されるようにするにはインスタンスを再起動する必要があります。

**Linuxインスタンス**

	# umount <マウントポイント>

**Windowsインスタンス**

**ディスクの管理**で該当のディスクを**オフライン**にした後、接続を解除します。

## スナップショットの作成

ブロックストレージの読み取り専用のコピーを作成します。ブロックストレージがインスタンスに接続されている状態でも、ブロックストレージのスナップショットを作成できますが、データの整合性と安定性を保障するには、インスタンスから接続を解除してブロックストレージのスナップショットを作成することを推奨します。

## ブロックストレージ複製

ブロックストレージを他のリージョンに複製して利用できます。ブロックストレージがインスタンスに接続されている状態でも複製できますが、データの整合性と安定性を保障するためにインスタンスを終了するか、接続を解除してから複製することを推奨します。

複製リクエスト後、複製状態および成否は[複製状況]で確認できます。

> [参考]
> レプリケーション機能は一度きりであり、それ以降の元のブロックストレージの変動事項は反映されません。

<!-- 改行のためのコメントのため必ず含める必要があります。 -->

> [注意]
> レプリケーションを進行するには、ブロックストレージ内に少なくとも100KB以上の空き容量が必要です。

### リージョン

現在利用中のリージョン以外の複製する対象リージョンを選択します。

### ブロックストレージタイプ

複製するリージョンで利用するブロックストレージタイプを選択します。現在のリージョンで利用中のブロックストレージタイプとは異なるタイプを選択できます。

### アベイラビリティゾーン

複製するリージョンで利用するアベイラビリティゾーンを選択します。現在のリージョンで利用中のアベイラビリティゾーンとは異なるアベイラビリティゾーンを選択できます。

## トラブルシューティング

### 意図しないブロックストレージで起動する問題

インスタンスに追加で接続したブロックストレージが`/`にマウントされた状態でインスタンスが起動することがあります。この現象は、主にインスタンスのOSイメージで作成されたブロックストレージを他のインスタンスに追加で接続するときに発生します。

Linuxは起動時に`/etc/fstab`で`/`にマウントするディスクを決定します。 NHN Cloudで使用するOSイメージの場合、ファイルシステムUUIDに基づいてマウントするディスクを決定します。ファイルシステムUUID値が同じブロックストレージが接続されると、意図しないブロックストレージが`/`にマウントされることがあります。

```console
# cat /etc/fstab
...
UUID=6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02 /                       xfs     defaults        0 0
```

`blkid`コマンドでブロックストレージのファイルシステムUUIDを確認できます。

```console
# blkid
/dev/vda1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"
/dev/vdb1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"
```

上記のように追加で接続したブロックストレージのファイルシステムUUIDが同じ場合、Linuxディストリビューション動作方式によっては追加で接続したブロックストレージが`/`にマウントされることがあります。

次の手順で2つのブロックストレージのファイルシステムUUIDが異なるようにして問題を解決します。

1. インスタンスを停止した後、問題を引き起こす(すなわち`/`で誤ってマウントされていた) [ブロックストレージの接続を解除](console-guide/#_5)します。

2. インスタンスを起動します。

3. 起動が完了したら、問題を引き起こす[ブロックストレージを再接続](console-guide/#_4)します。

4. 以下のコマンで問題を引き起こすブロックストレージのファイルシステムUUIDを変更します。問題を引き起こすブロックストレージのタイプに応じて以下のコマンドを実行します。ブロックストレージのタイプは`blkid`コマンドで確認できます。

	問題を引き起こすブロックストレージのファイルシステムがext4の場合、

	<pre><code class="language-console"># tune2fs -U random /dev/vdb1
	tune2fs 1.42.9 (28-Dec-2013)
	Setting the UUID on this filesystem could take some time.
	Proceed anyway (or wait 5 seconds to proceed) ? (y,N) y
	</code></pre>

	問題を引き起こすブロックストレージのファイルシステムがxfsの場合、

	<pre><code class="language-console"># xfs_admin -U generate /dev/vdb1
	Clearing log and setting UUID
	writing all SBs
	new UUID = 0037c590-0545-4736-bcdc-d052681eb5f5
	</code></pre>

5. ファイルシステムUUIDが変更されたことを確認します。

	<pre><code class="language-console"># blkid
	/dev/vda1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"
	/dev/vdb1: UUID="0037c590-0545-4736-bcdc-d052681eb5f5" TYPE="xfs"
	</code></pre>
